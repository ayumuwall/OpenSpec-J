# 実験的ワークフロー（OPSX）

> **ステータス:** 実験的です。壊れる可能性があります。フィードバックは [Discord](https://discord.gg/BYjPaKbqMt) へ。
>
> **互換性:** 現時点では Claude Code のみ

## 概要

OPSX は OpenSpec の変更に対する**流動的で反復的なワークフロー**です。固定のフェーズではなく、いつでも実行できるアクションで進めます。

## なぜ必要か

標準の OpenSpec ワークフローは機能しますが、**固定されている**点が課題です。

- **手順がハードコード** — TypeScript 内に埋め込まれており変更できない
- **一括実行** — 1 つのコマンドで全部作るため、個別にテストできない
- **固定構造** — 全員同じワークフローでカスタマイズできない
- **ブラックボックス** — AI の出力が悪いときにプロンプトを調整できない

**OPSX で開かれます。** これにより誰でも次のことが可能になります。

1. **指示を試せる** — テンプレートを編集し、AI の出力が改善するか確認
2. **粒度細かくテスト** — アーティファクトごとに手順を独立して検証
3. **ワークフローのカスタマイズ** — 独自のアーティファクトと依存関係を定義
4. **素早く反復** — テンプレートを変えて即テスト、ビルド不要

```
標準ワークフロー:                    OPSX:
┌────────────────────────┐           ┌────────────────────────┐
│  パッケージ固定         │           │  schema.yaml           │◄── ここを編集
│  （変更不可）           │           │  templates/*.md        │◄── またはここ
│        ↓               │           │        ↓               │
│  新リリースを待つ       │           │  即時反映              │
│        ↓               │           │        ↓               │
│  改善を祈る             │           │  自分で試せる          │
└────────────────────────┘           └────────────────────────┘
```

**これは全員のための仕組みです:**
- **チーム** — 実際の働き方に合うワークフローを作れる
- **パワーユーザー** — 自分のコードベース向けにプロンプトを調整できる
- **OpenSpec コントリビューター** — リリース無しで新しいアプローチを試せる

最適解はまだ模索中です。OPSX は学びを共有できるようにします。

## ユーザー体験

**線形ワークフローの問題:**
「計画フェーズ」「実装フェーズ」「完了」と進む前提ですが、現実の作業はそうなりません。実装してみると設計が違った、仕様を更新したくなった、実装を続ける必要がある。線形フェーズは実際の流れと衝突します。

**OPSX の考え方:**
- **フェーズではなくアクション** — 作成、実装、更新、アーカイブをいつでも実行できる
- **依存関係は許可条件** — 次に何ができるかを示すだけで、順番を強制しない
- **学びながら更新** — 実装途中で設計を修正して戻るのは自然

```
いつでも戻れます:

     ┌────────────────────────────────────┐
     │                                    │
     ▼                                    │
  proposal ──→ specs ──→ design ──→ tasks ──→ 実装
     ▲           ▲          ▲               │
     │           │          │               │
     └───────────┴──────────┴───────────────┘
              学びながら更新
```

## セットアップ

```bash
# 1. openspec がインストール済みで初期化されていることを確認
openspec init

# 2. 実験的スキルを生成
openspec artifact-experimental-setup
```

Claude Code が自動検出する `.claude/skills/` にスキルが作成されます。

## コマンド

| コマンド | 役割 |
|---------|------|
| `/opsx:explore` | アイデアの整理、問題の調査、要件の明確化を行う |
| `/opsx:new` | 新しい変更を開始 |
| `/opsx:continue` | 次に準備ができたアーティファクトを作成 |
| `/opsx:ff` | 早送り（計画アーティファクトを一括作成） |
| `/opsx:apply` | タスクを実装し、必要に応じてアーティファクトを更新 |
| `/opsx:sync` | 変更の仕様差分をメイン仕様に同期 |
| `/opsx:archive` | 完了後にアーカイブ |

## 使い方

### アイデアを探索する
```
/opsx:explore
```
アイデアを考え、問題を調査し、選択肢を比較します。構造は不要で、思考の相棒として使えます。洞察が固まったら `/opsx:new` または `/opsx:ff` に移行します。

### 新しい変更を始める
```
/opsx:new
```
何を作るかと、どのワークフロースキーマを使うかを尋ねられます。

### アーティファクトを作成する
```
/opsx:continue
```
依存関係にもとづいて作成可能なものを表示し、1 つのアーティファクトを作成します。繰り返し使って段階的に進めます。

```
/opsx:ff add-dark-mode
```
計画アーティファクトを一括で作成します。やることが明確なときに便利です。

### 実装する（流動的な部分）
```
/opsx:apply
```
タスクを順に進め、完了したらチェックを付けます。**重要な違い:** 実装中に問題が見つかったら、仕様・設計・タスクを更新して続行できます。フェーズのゲートはありません。

### 仕上げ
```
/opsx:sync      # 変更の仕様差分をメイン仕様に反映
/opsx:archive   # 完了後にアーカイブへ移動
```

## 更新するか、新規にするか

OPSX はいつでもアーティファクトを更新できます。ですが「学びながら更新」が「別の作業」に変わるのはいつでしょうか？

### 提案が捉えるもの

提案は 3 つを定義します。
1. **意図** — どの問題を解くのか
2. **スコープ** — どこまでが対象か
3. **アプローチ** — どう解決するのか

どれが、どれだけ変わったかが判断の鍵になります。

### 既存の変更を更新するのは次の場合

**同じ意図で、実行方法の洗練**
- 考慮していなかったエッジケースが見つかった
- 目標は同じでアプローチだけ調整する
- 実装中に設計のズレが分かった

**スコープが縮小**
- スコープが大きすぎるのでまず MVP を出す
- "ダークモードを追加" → "ダークモード切り替えを追加（v2 でシステム設定連動）"

**学びによる修正**
- コードベースの構造が想定と違った
- 依存関係が想定どおりに動かない
- "CSS 変数を使う" → "Tailwind の dark: プレフィックスを使う"

### 新しい変更を始めるのは次の場合

**意図が根本的に変わった**
- 解くべき問題が別物になった
- "ダークモードを追加" → "色・フォント・余白込みのテーマシステムを導入"

**スコープが膨らんだ**
- 変更が大きくなり、別作業になっている
- 更新すると元の提案が判別できない
- "ログインバグを修正" → "認証システムを刷新"

**元の変更が完了できる**
- 元の変更を「完了」にできる
- 新しい作業は独立している
- 完了 "ダークモード MVP" → アーカイブ → 新しい変更 "ダークモードを拡張"

### 判断の目安

```
                        ┌─────────────────────────────────────┐
                        │           同じ作業か？              │
                        └──────────────┬──────────────────────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
                    ▼                  ▼                  ▼
             意図が同じ？        重なり >50%？      変更なしで
             問題が同じ？        スコープ同じ？     完了できる？
                    │                  │                  │
          ┌────────┴────────┐  ┌──────┴──────┐   ┌───────┴───────┐
          │                 │  │             │   │               │
         はい             いいえ はい        いいえ いいえ        はい
          │                 │  │             │   │               │
          ▼                 ▼  ▼             ▼   ▼               ▼
         更新              新規 更新        新規 更新            新規
```

| テスト | 更新 | 新しい変更 |
|------|--------|------------|
| **同一性** | "同じものの洗練" | "別の作業" |
| **スコープの重なり** | 50% 以上 | 50% 未満 |
| **完了可能性** | 変更無しでは完了できない | 元の変更は完了でき、新しい作業は独立 |
| **ストーリー** | 更新の連鎖が一貫したストーリーになる | つぎはぎが分かりづらい |

### 原則

> **更新は文脈を保ち、新しい変更は明確さをもたらす。**
>
> 思考の履歴に価値があるなら更新を選ぶ。
> 新しく始めるほうが明瞭なら新しい変更を選ぶ。

git のブランチに例えると:
- 同じ機能に取り組む間はコミットを積み重ねる
- 本当に別作業なら新しいブランチを切る
- 部分的にマージして第 2 フェーズを新しく始めることもある

## 何が違うのか？

| | 標準（`/openspec:proposal`） | 実験的（`/opsx:*`） |
|---|---|---|
| **構造** | 1 つの大きな提案ドキュメント | 依存関係を持つ離散的なアーティファクト |
| **ワークフロー** | 直線的なフェーズ: 計画 → 実装 → アーカイブ | 流動的なアクション — いつでも何でもできる |
| **反復** | 戻るのが難しい | 学びながらアーティファクトを更新 |
| **カスタマイズ** | 固定構造 | スキーマ駆動（独自アーティファクトを定義） |

**重要な示唆:** 作業は直線的ではありません。OPSX はそれを前提にします。

## アーキテクチャ詳解

このセクションでは OPSX の内部構造と、標準ワークフローとの違いを説明します。

### 思想: フェーズ vs アクション

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         標準ワークフロー                                    │
│                    （フェーズ固定・一括完了）                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐             │
│   │    計画     │ ───► │    実装     │ ───► │  アーカイブ  │             │
│   │   フェーズ   │      │   フェーズ   │      │   フェーズ   │             │
│   └──────────────┘      └──────────────┘      └──────────────┘             │
│         │                     │                     │                       │
│         ▼                     ▼                     ▼                       │
│   /openspec:proposal   /openspec:apply      /openspec:archive              │
│                                                                             │
│   • 全アーティファクトを一括作成                                           │
│   • 実装中に仕様へ戻って更新できない                                       │
│   • フェーズゲートで直線的進行を強制                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                           OPSX ワークフロー                                  │
│                     （流動的アクション・反復）                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│              ┌────────────────────────────────────────────┐                 │
│              │         アクション（フェーズではない）        │                 │
│              │                                            │                 │
│              │   new ◄──► continue ◄──► apply ◄──► sync   │                 │
│              │    │          │           │          │     │                 │
│              │    └──────────┴───────────┴──────────┘     │                 │
│              │                順不同                       │                 │
│              └────────────────────────────────────────────┘                 │
│                                                                             │
│   • アーティファクトを 1 つずつ作成、または早送り                          │
│   • 実装中に specs/design/tasks を更新可能                                 │
│   • 依存関係で進行が開き、フェーズは存在しない                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### コンポーネント構成

**標準ワークフロー**は TypeScript 内にハードコードされたテンプレートを使います。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       標準ワークフロー構成                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ハードコードされたテンプレート（TypeScript 文字列）                       │
│                    │                                                        │
│                    ▼                                                        │
│   コンフィギュレータ（18+ クラス、エディタごと）                             │
│                    │                                                        │
│                    ▼                                                        │
│   生成されるコマンドファイル (.claude/commands/openspec/*.md)               │
│                                                                             │
│   • 固定構造でアーティファクトを認識しない                                  │
│   • 変更にはコード修正と再ビルドが必要                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**OPSX** は外部スキーマと依存グラフエンジンを使います。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           OPSX 構成                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   スキーマ定義（YAML）                                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  name: spec-driven                                                  │   │
│   │  artifacts:                                                         │   │
│   │    - id: proposal                                                   │   │
│   │      generates: proposal.md                                         │   │
│   │      requires: []              ◄── 依存関係                         │   │
│   │    - id: specs                                                      │   │
│   │      generates: specs/**/*.md  ◄── グロブパターン                    │   │
│   │      requires: [proposal]      ◄── proposal 後に解放                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                    │                                                        │
│                    ▼                                                        │
│   アーティファクトグラフエンジン                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  • トポロジカルソート（依存順）                                       │   │
│   │  • 状態判定（ファイル存在）                                           │   │
│   │  • リッチな指示生成（テンプレート＋コンテキスト）                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                    │                                                        │
│                    ▼                                                        │
│   スキルファイル (.claude/skills/openspec-*/SKILL.md)                       │
│                                                                             │
│   • クロスエディタ対応（Claude Code, Cursor, Windsurf）                      │
│   • スキルが CLI に問い合わせて構造化データを取得                           │
│   • スキーマファイルで完全カスタマイズ可能                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 依存関係グラフモデル

アーティファクトは有向非巡回グラフ（DAG）を形成します。依存関係は**ゲートではなく許可条件**です。

```
                              proposal
                             （ルートノード）
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                    ▼                           ▼
                 specs                       design
              (requires:                  (requires:
               proposal)                   proposal)
                    │                           │
                    └─────────────┬─────────────┘
                                  │
                                  ▼
                               tasks
                           (requires:
                           specs, design)
                                  │
                                  ▼
                          ┌──────────────┐
                          │ APPLY フェーズ │
                          │ (requires:   │
                          │  tasks)      │
                          └──────────────┘
```

**状態遷移:**

```
   BLOCKED ────────────────► READY ────────────────► DONE
      │                        │                       │
   依存が不足                依存がすべて DONE        ファイルが存在
   しています               になっている             しています
```

### 情報の流れ

**標準ワークフロー** — エージェントは静的な指示を受け取ります。

```
  ユーザー: "/openspec:proposal"
           │
           ▼
  ┌─────────────────────────────────────────┐
  │  静的な指示:                             │
  │  • proposal.md を作成                    │
  │  • tasks.md を作成                       │
  │  • design.md を作成                      │
  │  • specs/*.md を作成                     │
  │                                         │
  │  既存状態やアーティファクト間の依存を   │
  │  把握しない                              │
  └─────────────────────────────────────────┘
           │
           ▼
  エージェントが全アーティファクトを一括作成
```

**OPSX** — エージェントはリッチなコンテキストを照会します。

```
  ユーザー: "/opsx:continue"
           │
           ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │  手順 1: 現在状態を取得                                                  │
  │  ┌────────────────────────────────────────────────────────────────────┐  │
  │  │  $ openspec status --change "add-auth" --json                      │  │
  │  │                                                                    │  │
  │  │  {                                                                 │  │
  │  │    "artifacts": [                                                  │  │
  │  │      {"id": "proposal", "status": "done"},                         │  │
  │  │      {"id": "specs", "status": "ready"},      ◄── 最初に ready     │  │
  │  │      {"id": "design", "status": "ready"},                          │  │
  │  │      {"id": "tasks", "status": "blocked", "missingDeps": ["specs"]}│  │
  │  │    ]                                                               │  │
  │  │  }                                                                 │  │
  │  └────────────────────────────────────────────────────────────────────┘  │
  │                                                                          │
  │  手順 2: ready なアーティファクトの詳細指示を取得                        │
  │  ┌────────────────────────────────────────────────────────────────────┐  │
  │  │  $ openspec instructions specs --change "add-auth" --json          │  │
  │  │                                                                    │  │
  │  │  {                                                                 │  │
  │  │    "template": "# 仕様\n\n## ADDED Requirements...",              │  │
  │  │    "dependencies": [{"id": "proposal", "path": "...", "done": true}│  │
  │  │    "unlocks": ["tasks"]                                            │  │
  │  │  }                                                                 │  │
  │  └────────────────────────────────────────────────────────────────────┘  │
  │                                                                          │
  │  手順 3: 依存を読み、1 つ作成 → 解放内容を表示                           │
  └──────────────────────────────────────────────────────────────────────────┘
```

### イテレーションモデル

**標準ワークフロー** — 反復が難しい。

```
  ┌─────────┐     ┌─────────┐     ┌─────────┐
  │/proposal│ ──► │ /apply  │ ──► │/archive │
  └─────────┘     └─────────┘     └─────────┘
       │               │
       │               ├── "ちょっと、設計が違う"
       │               │
       │               ├── 選択肢:
       │               │   • 手動で編集（文脈が切れる）
       │               │   • 破棄してやり直す
       │               │   • 押し切って後で直す
       │               │
       │               └── 公式な「戻る」手段なし
       │
       └── 全アーティファクトを一括作成
```

**OPSX** — 自然に反復できる。

```
  /opsx:new ───► /opsx:continue ───► /opsx:apply ───► /opsx:archive
      │                │                  │
      │                │                  ├── "設計が違う"
      │                │                  │
      │                │                  ▼
      │                │            design.md を直して
      │                │            続行！
      │                │                  │
      │                │                  ▼
      │                │         /opsx:apply が
      │                │         中断箇所から再開
      │                │
      │                └── 1 つ作成し、解放内容を表示
      │
      └── 変更の土台を作成し、指示待ち
```

### カスタムスキーマ

`~/.local/share/openspec/schemas/` にスキーマを追加すれば独自ワークフローを作れます。

```
~/.local/share/openspec/schemas/research-first/
├── schema.yaml
└── templates/
    ├── research.md
    ├── proposal.md
    └── tasks.md

schema.yaml:
┌─────────────────────────────────────────────────────────────────┐
│  name: research-first                                           │
│  artifacts:                                                     │
│    - id: research        # proposal の前に追加                  │
│      generates: research.md                                     │
│      requires: []                                               │
│                                                                 │
│    - id: proposal                                               │
│      generates: proposal.md                                     │
│      requires: [research]  # research に依存                    │
│                                                                 │
│    - id: tasks                                                  │
│      generates: tasks.md                                        │
│      requires: [proposal]                                       │
└─────────────────────────────────────────────────────────────────┘

依存グラフ:

   research ──► proposal ──► tasks
```

### まとめ

| 観点 | 標準 | OPSX |
|--------|----------|------|
| **テンプレート** | TypeScript にハードコード | 外部 YAML + Markdown |
| **依存関係** | なし（一括） | DAG とトポロジカルソート |
| **状態** | フェーズベースのメンタルモデル | ファイルの存在で判定 |
| **カスタマイズ** | ソースを編集して再ビルド | schema.yaml を作成 |
| **反復** | フェーズ固定 | 流動的にどこでも編集 |
| **エディタ対応** | 18+ の configurator クラス | 単一の skills ディレクトリ |

## スキーマ

スキーマは、どのアーティファクトが存在し、どのように依存するかを定義します。現在利用可能なもの:

- **spec-driven**（デフォルト）: proposal → specs → design → tasks
- **tdd**: tests → implementation → docs

`openspec schemas` を実行すると利用可能なスキーマが表示されます。

## ヒント

- `/opsx:explore` でアイデアを整理してから変更を開始する
- `/opsx:ff` は方針が固まっているときに、`/opsx:continue` は探索中に向いています
- `/opsx:apply` の途中で問題が見つかったら、アーティファクトを修正して続行する
- `tasks.md` のチェックボックスで進捗を追跡します
- 行き詰まったら `openspec status --change "name"` で状況を確認できます

## フィードバック

荒削りなのは意図的です。何がうまくいくかを学んでいます。

バグやアイデアがあれば [Discord](https://discord.gg/BYjPaKbqMt) か [GitHub](https://github.com/Fission-AI/openspec/issues) へ。
